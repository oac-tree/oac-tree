#+======================================================================
# $HeadURL: https://svnpub.codac.iter.org/codac/iter/codac/dev/units/m-sup-common-cpp/branches/codac-core-6.2/src/main/c++/core/Makefile $
# $Id: Makefile 105560 2020-01-13 10:24:44Z kimh19 $
#
# Project       : CODAC Core System
#
# Description   : C++ Makefile
#
# Author        : This file was generated by CODAC development toolkit
#
# Copyright (c) : 2010-2020 ITER Organization,
#                 CS 90 046
#                 13067 St. Paul-lez-Durance Cedex
#                 France
#
# This file is part of ITER CODAC software.
# For the terms and conditions of redistribution or use of this software
# refer to the file ITER-LICENSE.TXT located in the top level directory
# of the distribution package.
#
#-======================================================================

LIBNAME=MathExpressionEngineExptrk

#LIBVERSION=1.1.0

SONAME=lib$(LIBNAME).so
REALNAME=lib$(LIBNAME).so

LIBRARIES := stdc++ rt pthread dl 
LIBRARIES += ccs-core ccs-common ccs-base ccs-types

LIBRARY_DIRS := 

INCLUDE_DIRS := .
INCLUDE_DIRS += ../..

ifdef CODAC_ROOT
LIBRARY_DIRS += $(CODAC_ROOT)/lib
LIBRARY_DIRS += $(EPICS_BASE)/lib/$(EPICS_HOST_ARCH)
INCLUDE_DIRS += $(CODAC_ROOT)/include
INCLUDE_DIRS += $(CODAC_ROOT)/include/common
INCLUDE_DIRS += $(EPICS_BASE)/include $(EPICS_BASE)/include/os/Linux $(EPICS_BASE)/include/compiler/gcc
endif

TARGET=../../../../../target

SRC_DIR := .
LIB_DIR := $(TARGET)/lib
## Bug 10805 - Coverage report handled through MVN
#OBJ_DIR := $(TARGET)/obj
OBJ_DIR := $(SRC_DIR)/.obj


INCLUDES=$(foreach inc,$(INCLUDE_DIRS),-I$(inc))

ifdef CODAC_ROOT
LDLIBS=$(foreach libs,$(LIBRARY_DIRS),-L$(libs)) $(foreach libs,$(LIBRARIES),-l$(libs))
else
LDLIBS=$(foreach libs,$(LIBRARY_DIRS),-L$(libs) -Wl,--no-as-needed) $(foreach libs,$(LIBRARIES),-l$(libs)) -pthread
endif

SOURCES := $(wildcard $(SRC_DIR)/*.cpp $(SRC_DIR)/*.c)

OBJECTS := $(addprefix $(OBJ_DIR)/,$(patsubst %.cpp,%.obj,$(notdir $(SOURCES))))

GPP=g++

OPTIONS := -fPIC -c -std=c++11 -fpermissive -O2
#OPTIONS += -pedantic -Wall -Werror -Wextra
OPTIONS += -Wall
## Temporary
## ToDo - Fix log-api.h
OPTIONS += -Wno-variadic-macros
## ToDo - any-type.cpp
OPTIONS += -Wno-format
OPTIONS += -DBUILD_DATE=\"$(shell date +'%FT%H:%M')\"
OPTIONS += -DBUILD_USER=\"$(shell whoami)\"
OPTIONS += -g -Dexprtk_disable_caseinsensitivity -Dexprtk_disable_rtl_vecops
# Link against libxml2


## Bug 10805 - Coverage report handled through MVN
ifeq ($(COVERAGE),true)
OPTIONS += -DDEBUG -O0 -g -fprofile-arcs -ftest-coverage --coverage
LDFLAGS += --coverage
endif

all: libs 

clean:
	@rm -rf ./*~ ./include/*~ 
	@rm -rf $(OBJ_DIR) $(LIB_DIR)/lib$(LIBNAME)*

libs: staticlib dynamiclib

staticlib: $(OBJECTS) 
	@mkdir -p $(LIB_DIR)
	$(AR) $(ARFLAGS) $(LIB_DIR)/lib$(LIBNAME).a $^

dynamiclib: $(OBJECTS) 
	@mkdir -p $(LIB_DIR)
	$(GPP) -shared $(LDFLAGS) $(LDLIBS) -Wl,-soname,$(SONAME) -o $(LIB_DIR)/$(REALNAME) $^

$(OBJ_DIR)/%.obj: $(SRC_DIR)/%.cpp
	@mkdir -p $(OBJ_DIR)
	$(GPP) $(OPTIONS) $(INCLUDES) $< -o $@

	